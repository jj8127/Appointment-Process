# 보안 조치 정리 (앱 + 웹)

이 문서는 `e:\hanhwa\fc-onboarding-app` 프로젝트에서 앱/웹 전반에 적용된 보안 조치를 정리한 것입니다.
구현 근거는 각 항목에 관련 파일 경로로 함께 표기했습니다.

## 1) 데이터 보호 및 암호화
- 주민번호/주소 암호화 (AES-GCM)
  - 주민번호/주소는 `fc_identity_secure` 테이블에 AES-GCM으로 암호화 저장.
  - `store-identity` Edge Function에서만 암호화 처리.
  - 관련: `supabase/functions/store-identity/index.ts`, `supabase/schema.sql`
- 주민번호 해시 및 마스킹
  - 중복 체크용으로 `resident_id_hash`(SHA-256 + salt) 저장.
  - UI 표시용 마스킹(`resident_id_masked`)만 `fc_profiles`에 저장.
  - 관련: `supabase/functions/store-identity/index.ts`, `supabase/schema.sql`
- 비밀번호 해시(PBKDF2)
  - PBKDF2(100,000, SHA-256) + 랜덤 salt로 해시 저장.
  - FC/관리자/본부장 동일 정책 적용.
  - 관련: `supabase/functions/set-password/index.ts`, `supabase/functions/reset-password/index.ts`, `supabase/functions/login-with-password/index.ts`, `supabase/schema.sql`
- OTP/리셋 토큰 해시 저장
  - OTP/리셋 코드는 DB에 SHA-256 해시로 저장, 평문 저장/반환 금지.
  - 관련: `supabase/functions/request-signup-otp/index.ts`, `supabase/functions/verify-signup-otp/index.ts`, `supabase/functions/request-password-reset/index.ts`, `supabase/functions/reset-password/index.ts`
- 비공개 스토리지 + 서명 URL
  - `fc-documents`, `board-attachments` 버킷은 public=false + RLS 정책 적용.
  - 문서 열람은 서명 URL로 제한.
  - 관련: `supabase/schema.sql`, `web/src/app/api/admin/fc/route.ts`

## 2) 인증/계정 보안
- 커스텀 전화번호 + 비밀번호 인증
  - Supabase Auth 대신 Edge Function 기반 커스텀 인증 사용.
  - 관련: `supabase/functions/login-with-password/index.ts`, `adr/0002-custom-authentication-system.md`
- 로그인 실패 잠금(Brute-force 방지)
  - 실패 5회 시 10분 잠금 (admin/manager/fc 동일).
  - 관련: `supabase/functions/login-with-password/index.ts`, `supabase/schema.sql`
- OTP 인증 보호
  - OTP TTL(5분), 재전송 쿨다운(60초), 시도 제한(5회) 후 잠금.
  - 관련: `supabase/functions/request-signup-otp/index.ts`, `supabase/functions/verify-signup-otp/index.ts`
- 비밀번호 재설정 보호
  - 리셋 코드 TTL(15분), 요청 쿨다운(60초), 해시 저장.
  - 관련: `supabase/functions/request-password-reset/index.ts`, `supabase/functions/reset-password/index.ts`
- 계정 활성화 체크
  - 관리자/본부장 계정 active 플래그 검사.
  - 관련: `supabase/functions/login-with-password/index.ts`
- 비밀번호 복잡도 정책
  - 8자 이상, 영문+숫자+특수문자.
  - 관련: `supabase/functions/set-password/index.ts`, `supabase/functions/reset-password/index.ts`

## 3) 접근 제어 (RLS/권한)
- 전 테이블 RLS 활성화
  - `fc_profiles`, `fc_documents`, `fc_identity_secure`, `fc_credentials`, `exam_*`, `notifications`, `notices` 등.
  - 역할별 정책: admin/manager/FC 접근 분리.
  - 관련: `supabase/schema.sql`
- 게시판은 서비스 롤 전용 접근
  - 게시판 테이블/스토리지는 `service_role`만 접근 가능.
  - 관련: `supabase/schema.sql`
- Edge Function에서 역할 검증
  - 게시판 함수에서 actor 검증 및 역할 제한.
  - 관련: `supabase/functions/_shared/board.ts`
- 관리자 전용 서버 API + 서비스 롤
  - 웹 관리자 mutation은 서버 API(`/api/admin/*`)에서만 수행.
  - 서버 측에서 service role 사용, 세션 쿠키 검증.
  - 관련: `web/src/lib/admin-supabase.ts`, `web/src/app/api/admin/fc/route.ts`
- 관리자/본부장 권한 분리
  - 본부장(읽기 전용) UI에서 수정 버튼 비활성화.
  - 관련: `web/src/hooks/use-session.tsx`, `web/src/app/dashboard/*`

## 4) CSRF/요청 보호
- Origin/Referer 검사
  - 민감 서버 액션에서 origin 검증.
  - 관련: `web/src/lib/csrf.ts`
- 간단 레이트 리밋
  - 문서/위촉 업데이트 등 서버 액션에 분당 요청 제한.
  - 관련: `web/src/lib/csrf.ts`, `web/src/app/dashboard/docs/actions.ts`, `web/src/app/dashboard/appointment/actions.ts`, `web/src/app/api/fc-delete/route.ts`
- 세션 검증
  - 관리자 전용 API에서 role/세션 쿠키 검증.
  - 관련: `web/src/app/api/admin/fc/route.ts`, `web/src/app/api/fc-delete/route.ts`

## 5) 클라이언트 세션/저장소 보호
- 모바일 세션 저장소 안전화
  - `SecureStore` 우선 사용, 실패 시 AsyncStorage/File/memory로 단계적 폴백.
  - 관련: `lib/safe-storage.ts`, `hooks/use-session.tsx`
- 웹 세션 쿠키 보안 설정
  - `SameSite=Strict`, HTTPS 환경에서 `Secure` 적용.
  - 로컬스토리지는 단순 난독화 저장(보안 보조).
  - 관련: `web/src/hooks/use-session.tsx`

## 6) 외부 연동 보안
- SMS 발송 서명(HMAC)
  - NCP SENS API 호출 시 HMAC 서명 사용.
  - 관련: `supabase/functions/request-signup-otp/index.ts`, `supabase/functions/request-password-reset/index.ts`
- Web Push/알림 서버 프록시
  - 클라이언트에서 직접 service role 사용 금지, 서버 API에서만 처리.
  - 관련: `web/src/app/api/fc-notify/route.ts`, `web/src/app/actions.ts`

## 7) 입력 검증/제약
- 입력 포맷 검증
  - 전화번호/날짜/코드 형식 검증 및 정규화.
  - 관련: `supabase/functions/*/index.ts`
- 첨부 파일 제한 및 파일명 정리
  - 게시판 첨부 수/용량 제한, 파일명 정규화.
  - 관련: `supabase/functions/_shared/board.ts`
- DB 제약 및 유니크 인덱스
  - 역할/상태 체크 제약, 전화번호/주민번호 해시 유니크 인덱스.
  - 관련: `supabase/schema.sql`

## 8) 데이터 삭제/정리
- 계정 삭제 시 연관 데이터 정리
  - FC 문서/스토리지/알림/토큰/시험 신청 등 연계 데이터 삭제.
  - 관련: `supabase/functions/delete-account/index.ts`, `web/src/app/api/fc-delete/route.ts`

## 9) 운영 설정(보안 관련 환경 변수)
- Edge Function 공통
  - `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_URL` 필수.
  - `ALLOWED_ORIGINS`로 CORS 허용 도메인 제한.
  - 관련: `supabase/functions/*/index.ts`
- 민감 인증 키
  - 주민번호 암호화 키: `FC_IDENTITY_KEY`, 해시 salt: `FC_IDENTITY_HASH_SALT`.
  - 관련: `supabase/functions/store-identity/index.ts`
- 테스트/우회 옵션 (운영 비활성 권장)
  - `TEST_SMS_MODE`, `SMS_BYPASS_ENABLED`, `SMS_BYPASS_CODE`는 개발 편의용.
  - 운영 환경에서는 비활성/폐기 필요.
  - 관련: `supabase/functions/request-signup-otp/index.ts`, `supabase/functions/verify-signup-otp/index.ts`, `supabase/functions/reset-password/index.ts`

## 참고 문서
- 설계 결정: `adr/0002-custom-authentication-system.md`
- 구현 요약: `CLAUDE.md`
